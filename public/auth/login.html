<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QAcademy — Login Bridge</title>
  <link rel="stylesheet" href="/assets/app.css" />
</head>
<body>
  <div class="topbar">
    <div class="brand">
      <div class="dot"></div>
      <div>
        <div class="brand-title">QAcademy</div>
        <div class="brand-sub">Login bridge</div>
      </div>
    </div>
    <div class="top-actions">
      <a class="btn ghost" href="/">Home</a>
    </div>
  </div>

  <main class="wrap">
    <section class="card">
      <h1>Signing you in…</h1>
      <p class="muted" id="msg">Exchanging handoff code…</p>

      <div class="banner error" id="err" style="display:none;"></div>

      <div class="divider"></div>

      <div class="row gap">
        <button class="btn" id="btnRetry" type="button" style="display:none;">Retry</button>
        <button class="btn danger" id="btnSignOut" type="button" style="display:none;">Clear token</button>
      </div>

      <div class="note" id="help" style="display:none;">
        <b>No handoff code found.</b><br/>
        This page must be opened via the Portal/Blogger Teacher Access button (handoff).<br/>
        <span id="portalLinkWrap" style="display:none;">
          <br/><a class="btn" id="portalLink" href="#" target="_self">Go to Teacher Access (Portal)</a>
        </span>
      </div>
    </section>
  </main>

  <script src="/assets/app.js"></script>
  <script>
    (function(){
      const qs = QA.qs();
      const code = (qs.get("code") || "").trim();
      const returnTo = QA.safePath(qs.get("return_to") || "");

      const msg = document.getElementById("msg");
      const err = document.getElementById("err");
      const help = document.getElementById("help");
      const btnRetry = document.getElementById("btnRetry");
      const btnSignOut = document.getElementById("btnSignOut");

      function showError(text){
        err.style.display = "block";
        err.textContent = text;
      }

      function showHelpNoCode(){
        msg.textContent = "No handoff code in URL.";
        help.style.display = "block";

        if (QA.PORTAL_TEACHER_HANDOFF_URL) {
          const wrap = document.getElementById("portalLinkWrap");
          const a = document.getElementById("portalLink");
          a.href = QA.PORTAL_TEACHER_HANDOFF_URL;
          wrap.style.display = "block";
        }

        btnSignOut.style.display = "inline-flex";
      }

      async function routeNow(){
        await QA.routeByRole({ preferReturnTo: returnTo || null });
      }

      btnRetry.addEventListener("click", function(){
        location.reload();
      });

      btnSignOut.addEventListener("click", function(){
        QA.signOut();
      });

      (async function run(){
        // If user already has a token on Pages domain, route immediately.
        const existing = QA.getToken();
        if (!code && existing) {
          msg.textContent = "Already signed in on this domain. Routing…";
          return routeNow();
        }

        if (!code) {
          return showHelpNoCode();
        }

        msg.textContent = "Exchanging handoff code…";

        let ex = null;
        try {
          ex = await QA.exchangeHandoff(code);
        } catch(e){
          ex = { ok:false, error:String(e && (e.message || e) || e) };
        }

        if (!ex || !ex.ok || !ex.token) {
          showError("Handoff exchange failed: " + (ex && (ex.error || ex.detail) ? (ex.error || ex.detail) : "unknown"));
          msg.textContent = "Could not sign you in.";
          btnRetry.style.display = "inline-flex";
          btnSignOut.style.display = "inline-flex";
          return;
        }

        // Store token on Pages domain
        QA.setToken(ex.token);

        msg.textContent = "Signed in. Routing…";
        return routeNow();
      })();
    })();
  </script>
</body>
</html>
